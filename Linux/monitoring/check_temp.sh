#!/bin/bash
#
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã
# –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram.
# release 1.1
#

# –°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: –≤—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ, –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ω–µ–æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
set -euo pipefail

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

SCRIPT_DIR=$(dirname "$(readlink -f "$0")")

source "${SCRIPT_DIR}/config.ini"
source "${SCRIPT_DIR}/secrets.ini"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
source "${SCRIPT_DIR}/send_telegram.sh"

# --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ---

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É—Ç–∏–ª–∏—Ç–∞ 'sensors'
if ! command -v sensors &> /dev/null; then
    echo "INFO: –ö–æ–º–∞–Ω–¥–∞ 'sensors' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ 'lm-sensors'. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è."
    exit 0
fi

echo "–ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã..."

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–µ—Ä–µ–≥—Ä–µ–≤–∞—Ö
CRITICAL_ALERTS=""
WARNING_ALERTS=""

#
# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–¥–µ–∂–Ω—É—é –∫–æ–º–∞–Ω–¥—É 'sed' –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—ã–≤–æ–¥–∞ 'sensors'
# –≤ —á–∏—Å—Ç—ã–π —Ñ–æ—Ä–º–∞—Ç '–ò–º—è–î–∞—Ç—á–∏–∫–∞:–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞'.

SENSORS_DATA=$(sensors | sed -n -E 's/^(.*[^[:space:]]):\s+\+([0-9.]+).*/\1:\2/p')


if [[ -z "$SENSORS_DATA" ]]; then
    echo "INFO: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ –æ—Ç —É—Ç–∏–ª–∏—Ç—ã 'sensors'."
    exit 0
fi

while IFS=':' read -r SENSOR_NAME TEMP; do
    # –£–±–∏—Ä–∞–µ–º –¥—Ä–æ–±–Ω—É—é —á–∞—Å—Ç—å –¥–ª—è —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    TEMP_INT=${TEMP%.*}
    
    echo "  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—á–∏–∫–∞: ${SENSOR_NAME} | –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${TEMP}¬∞C"

    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ CRITICAL, –ø–æ—Ç–æ–º –Ω–∞ WARNING
    if (( TEMP_INT >= TEMP_THRESHOLD_CRITICAL )); then
        CRITICAL_ALERTS+="üî• *${SENSOR_NAME}:* \`${TEMP}¬∞C\` (–ü–æ—Ä–æ–≥: ${TEMP_THRESHOLD_CRITICAL}¬∞C)\n"
    elif (( TEMP_INT >= TEMP_THRESHOLD_WARNING )); then
        WARNING_ALERTS+="‚ö†Ô∏è *${SENSOR_NAME}:* \`${TEMP}¬∞C\` (–ü–æ—Ä–æ–≥: ${TEMP_THRESHOLD_WARNING}¬∞C)\n"
    fi
done <<< "$SENSORS_DATA"


# –ï—Å–ª–∏ –±—ã–ª–∏ —Å–æ–±—Ä–∞–Ω—ã –∫–∞–∫–∏–µ-–ª–∏–±–æ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è, —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–¥–Ω–æ –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
if [[ -n "$CRITICAL_ALERTS" || -n "$WARNING_ALERTS" ]]; then
    HOST=$(hostname)
    TIME=$(date '+%Y-%m-%d %H:%M:%S')

    MSG=$(cat <<EOF
üå°Ô∏è *–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–µ—Ä–µ–≥—Ä–µ–≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ${HOST}* üå°Ô∏è

üïí *–í—Ä–µ–º—è:* ${TIME}

*–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è:*
${CRITICAL_ALERTS:-–ù–µ—Ç}

*–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:*
${WARNING_ALERTS:-–ù–µ—Ç}
EOF
)

    echo "!!! –û–ë–ù–ê–†–£–ñ–ï–ù –ü–ï–†–ï–ì–†–ï–í! –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram..."
    send_telegram "$MSG"
    echo "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."
else
    echo "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤ –Ω–æ—Ä–º–µ."
fi

exit 0
