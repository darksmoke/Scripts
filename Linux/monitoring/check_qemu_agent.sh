#!/bin/bash
# /opt/monitoring/check_qemu_agent.sh
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ QEMU Guest Agent –≤–Ω—É—Ç—Ä–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω.
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏.

set -uo pipefail

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
source "${SCRIPT_DIR}/utils.sh"
source "${SCRIPT_DIR}/config.sh"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ virsh (—É—Ç–∏–ª–∏—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è libvirt)
if ! command -v virsh &> /dev/null; then
    # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –≥–∏–ø–µ—Ä–≤–∏–∑–æ—Ä, –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º
    exit 0
fi

HOST=$(hostname)
HAS_ERROR=0
REPORT=""

# 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ ID –∏ –∏–º–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã—Ö –í–ú
# --state-running: —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ
# --name: –≤—ã–≤–æ–¥ —Ç–æ–ª—å–∫–æ –∏–º–µ–Ω
RUNNING_VMS=$(virsh list --state-running --name | sed '/^$/d')

# 2. –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –≤—ã—Ö–æ–¥–∏–º (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –í–ú)
if [[ -z "$RUNNING_VMS" ]]; then
    exit 0
fi

for vm in $RUNNING_VMS; do
    # 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∏–º–µ–Ω–∏ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∞ –≤ –∫–æ–Ω—Ñ–∏–≥–µ)
    if [[ -n "${VM_NAME_FILTER:-}" ]]; then
        if [[ ! "$vm" =~ ${VM_NAME_FILTER} ]]; then
            continue # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –∏–º—è –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç
        fi
    fi

    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≥–µ–Ω—Ç–∞
    # 2>&1 –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –∏—Ö –ø—Ä–æ—á–∏—Ç–∞—Ç—å
    # timeout 5 –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
    OUTPUT=$(timeout 5 virsh qemu-agent-command "$vm" '{"execute":"guest-ping"}' 2>&1)
    EXIT_CODE=$?

    # –ï—Å–ª–∏ –∫–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞ 0 (—É—Å–ø–µ—Ö), –∑–Ω–∞—á–∏—Ç –∞–≥–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∏–ª.
    if [[ "$EXIT_CODE" -ne 0 ]]; then
        # –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ—Ç –ª–∏—à–Ω–µ–≥–æ –º—É—Å–æ—Ä–∞ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
        CLEAN_ERROR=$(echo "$OUTPUT" | tr -d '\n' | sed 's/error: //g')
        
        REPORT+="üî∏ *VM:* \`${vm}\`\n–û—à–∏–±–∫–∞: _${CLEAN_ERROR}_\n\n"
        HAS_ERROR=1
    fi
done

ALERT_ID="qemu_agent_status"

if [[ "$HAS_ERROR" -eq 1 ]]; then
    MSG=$(cat <<EOF
üïµÔ∏è *QEMU Agent –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${HOST}*

–ê–≥–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –í–ú:
${REPORT}
_–ë–µ–∑ –∞–≥–µ–Ω—Ç–∞ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –±—ç–∫–∞–ø –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∏—Ç–∞–Ω–∏–µ–º._
EOF
)
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º ERROR
    manage_alert "$ALERT_ID" "ERROR" "$MSG"
else
    # –ï—Å–ª–∏ –≤—Å—ë —á–∏—Å—Ç–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–ª–µ—Ä—Ç
    manage_alert "$ALERT_ID" "OK" ""
fi

exit 0
