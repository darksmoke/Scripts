#!/bin/bash
#
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏—Å–∫–æ–≤–æ–π –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã (IO Wait)
# –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram.
# v.1.1
#

# –°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: –≤—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ, –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ω–µ–æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
set -euo pipefail

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

SCRIPT_DIR=$(dirname "$(readlink -f "$0")")

source "${SCRIPT_DIR}/config.ini"
source "${SCRIPT_DIR}/secrets.ini"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
source "${SCRIPT_DIR}/send_telegram.sh"

# --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ---

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–º–∞–Ω–¥—ã iostat
if ! command -v iostat &> /dev/null; then
    echo "–û–®–ò–ë–ö–ê: –ö–æ–º–∞–Ω–¥–∞ 'iostat' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞–∫–µ—Ç 'sysstat'." >&2
    exit 1
fi

echo "–ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ IO Wait..."

#
# –§–ò–ù–ê–õ–¨–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–∞–±–ª–æ–Ω awk, –∫–æ—Ç–æ—Ä—ã–π –∏—â–µ—Ç —Å—Ç—Ä–æ–∫–∏,
# –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å –ø—Ä–æ–±–µ–ª–æ–≤, –∞ –∑–∞—Ç–µ–º —Å —Ü–∏—Ñ—Ä—ã. –≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–µ–º—É –≤—ã–≤–æ–¥—É.
#
CURRENT_IOWAIT=$(LC_ALL=C iostat -c 2 3 | awk '/^[[:space:]]+[0-9]/ { S = $0 } END { print S }' | awk '{print $4}')

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –ø—É—Å—Ç–∞—è
if [[ -z "$CURRENT_IOWAIT" ]]; then
    echo "–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ IO Wait –æ—Ç iostat." >&2
    echo "--- –û–¢–õ–ê–î–û–ß–ù–´–ô –í–´–í–û–î iostat ---"
    LC_ALL=C iostat -c 2 3
    echo "---------------------------------"
    exit 1
fi

echo "–î–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:"
echo "  - –¢–µ–∫—É—â–∏–π IO Wait: ${CURRENT_IOWAIT}%"
echo "  - –ü–æ—Ä–æ–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è: ${IO_WAIT_THRESHOLD}%"

# –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –ø–æ—Ä–æ–≥–æ–º, –∏—Å–ø–æ–ª—å–∑—É—è 'bc'
IS_OVERLOADED=$(echo "${CURRENT_IOWAIT} > ${IO_WAIT_THRESHOLD}" | bc -l)

if [[ "$IS_OVERLOADED" -eq 1 ]]; then
  # –ù–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∞, —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
  HOST=$(hostname)
  TIME=$(date '+%Y-%m-%d %H:%M:%S')

  MSG=$(cat <<EOF
‚ö°Ô∏è *–í—ã—Å–æ–∫–∏–π IO Wait –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ${HOST}* ‚ö°Ô∏è

üïí *–í—Ä–µ–º—è:* ${TIME}
üìà *–¢–µ–∫—É—â–∏–π IO Wait:* \`${CURRENT_IOWAIT}%\`
üìä *–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–æ—Ä–æ–≥:* \`${IO_WAIT_THRESHOLD}%\`

–≠—Ç–æ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–∏—Å–∫–æ–≤–æ–π –ø–æ–¥—Å–∏—Å—Ç–µ–º–æ–π (–º–µ–¥–ª–µ–Ω–Ω—ã–π –¥–∏—Å–∫, –±–æ–ª—å—à–∞—è –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤).
EOF
)

  echo "–ü–†–ï–í–´–®–ï–ù–ò–ï –ü–û–†–û–ì–ê! –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram..."
  send_telegram "$MSG"
  echo "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."

else
  # –ù–∞–≥—Ä—É–∑–∫–∞ –≤ –Ω–æ—Ä–º–µ
  echo "IO Wait –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã."
fi

exit 0
