#!/bin/bash
#
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏—Å–∫–æ–≤–æ–π –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã (IO Wait)
# –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram.
# v.1.0
#

# –°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: –≤—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ, –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ω–µ–æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
set -euo pipefail

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º
SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
CONFIG_FILE="${SCRIPT_DIR}/config.ini"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if [[ ! -f "$CONFIG_FILE" ]]; then
  echo "–û–®–ò–ë–ö–ê: –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ '${CONFIG_FILE}' –Ω–µ –Ω–∞–π–¥–µ–Ω!" >&2
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–º–∞–Ω–¥—ã iostat
if ! command -v iostat &> /dev/null; then
    echo "–û–®–ò–ë–ö–ê: –ö–æ–º–∞–Ω–¥–∞ 'iostat' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞–∫–µ—Ç 'sysstat'." >&2
    exit 1
fi

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ config.ini –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
source "$CONFIG_FILE"
source "${SCRIPT_DIR}/send_telegram.sh"


# --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ---

echo "–ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ IO Wait..."

# –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ %iowait.
# 'iostat -c 1 2' –¥–µ–ª–∞–µ—Ç 2 –∑–∞–º–µ—Ä–∞ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º –≤ 1 —Å–µ–∫—É–Ω–¥—É.
# –ü–µ—Ä–≤—ã–π –∑–∞–º–µ—Ä - —Å—Ä–µ–¥–Ω–µ–µ —Å –º–æ–º–µ–Ω—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ–≥–æ —Å –ø–æ–º–æ—â—å—é tail -n 1).
# –í—Ç–æ—Ä–æ–π –∑–∞–º–µ—Ä - —Å—Ä–µ–¥–Ω–µ–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–µ–∫—É–Ω–¥—É (—Ç–æ, —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ).
# awk '{print $4}' –∏–∑–≤–ª–µ–∫–∞–µ—Ç 4-—é –∫–æ–ª–æ–Ω–∫—É (%iowait).
# LC_ALL=C - –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤—ã–≤–æ–¥–∞ iostat (—á—Ç–æ–±—ã —Ç–æ—á–∫–∞ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ —Ç–æ—á–∫–æ–π).
CURRENT_IOWAIT=$(LC_ALL=C iostat -c 1 2 | tail -n 1 | awk '{print $4}')

echo "–î–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:"
echo "  - –¢–µ–∫—É—â–∏–π IO Wait: ${CURRENT_IOWAIT}%"
echo "  - –ü–æ—Ä–æ–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è: ${IO_WAIT_THRESHOLD}%"

# –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –ø–æ—Ä–æ–≥–æ–º, –∏—Å–ø–æ–ª—å–∑—É—è 'bc'
IS_OVERLOADED=$(echo "${CURRENT_IOWAIT} > ${IO_WAIT_THRESHOLD}" | bc -l)

if [[ "$IS_OVERLOADED" -eq 1 ]]; then
  # –ù–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∞, —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
  HOST=$(hostname)
  TIME=$(date '+%Y-%m-%d %H:%M:%S')

  MSG=$(cat <<EOF
‚ö°Ô∏è *–í—ã—Å–æ–∫–∏–π IO Wait –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ: ${HOST}* ‚ö°Ô∏è

üïí *–í—Ä–µ–º—è:* ${TIME}
üìà *–¢–µ–∫—É—â–∏–π IO Wait:* \`${CURRENT_IOWAIT}%\`
üìä *–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø–æ—Ä–æ–≥:* \`${IO_WAIT_THRESHOLD}%\`

–≠—Ç–æ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–∏—Å–∫–æ–≤–æ–π –ø–æ–¥—Å–∏—Å—Ç–µ–º–æ–π (–º–µ–¥–ª–µ–Ω–Ω—ã–π –¥–∏—Å–∫, –±–æ–ª—å—à–∞—è –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤).
EOF
)

  echo "–ü–†–ï–í–´–®–ï–ù–ò–ï –ü–û–†–û–ì–ê! –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram..."
  send_telegram "$MSG"
  echo "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."

else
  # –ù–∞–≥—Ä—É–∑–∫–∞ –≤ –Ω–æ—Ä–º–µ
  echo "IO Wait –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã."
fi

exit 0
