#!/bin/bash
#
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ CPU (load average) –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram.
# v.1.0
#

# –°—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º: –≤—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ, –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ω–µ–æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
set -euo pipefail

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º
SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
CONFIG_FILE="${SCRIPT_DIR}/config.ini"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if [[ ! -f "$CONFIG_FILE" ]]; then
  echo "–û–®–ò–ë–ö–ê: –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ '${CONFIG_FILE}' –Ω–µ –Ω–∞–π–¥–µ–Ω!" >&2
  exit 1
fi

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ config.ini –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
source "$CONFIG_FILE"
source "${SCRIPT_DIR}/send_telegram.sh"


# --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ---

echo "–ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ CPU..."

# –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
CORES=$(nproc)
# –ü–æ–ª—É—á–∞–µ–º 1-–º–∏–Ω—É—Ç–Ω—ã–π load average (–ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ –∏–∑ /proc/loadavg)
LOAD_AVG=$(awk '{print $1}' /proc/loadavg)

# –í—ã—á–∏—Å–ª—è–µ–º –ø–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ load average –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞.
# –ò—Å–ø–æ–ª—å–∑—É–µ–º 'bc' –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π.
THRESHOLD_VALUE=$(echo "scale=2; ${CORES} * ${CPU_THRESHOLD_PERCENT} / 100" | bc)

echo "–î–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:"
echo "  - –Ø–¥–µ—Ä: ${CORES}"
echo "  - –¢–µ–∫—É—â–∏–π Load Average (1 min): ${LOAD_AVG}"
echo "  - –ü–æ—Ä–æ–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (%): ${CPU_THRESHOLD_PERCENT}%"
echo "  - –ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ Load Average: ${THRESHOLD_VALUE}"

# –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –Ω–∞–≥—Ä—É–∑–∫—É —Å –ø–æ—Ä–æ–≥–æ–≤–æ–π.
# '1' - –µ—Å–ª–∏ LOAD_AVG > THRESHOLD_VALUE, '0' - –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ.
IS_OVERLOADED=$(echo "${LOAD_AVG} > ${THRESHOLD_VALUE}" | bc)

if [[ "$IS_OVERLOADED" -eq 1 ]]; then
  # –ù–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∞, —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
  HOST=$(hostname)
  TIME=$(date '+%Y-%m-%d %H:%M:%S')

  MSG=$(cat <<EOF
üî• *–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU: ${HOST}* üî•

üïí *–í—Ä–µ–º—è:* ${TIME}
‚öôÔ∏è *–Ø–¥–µ—Ä:* ${CORES}
üìà *–¢–µ–∫—É—â–∏–π Load Average:* \`${LOAD_AVG}\`
üìä *–ü–æ—Ä–æ–≥ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è:* \`${THRESHOLD_VALUE}\` (>${CPU_THRESHOLD_PERCENT}%)

–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –Ω–æ—Ä–º—É.
EOF
)

  echo "–ü–†–ï–í–´–®–ï–ù–ò–ï –ü–û–†–û–ì–ê! –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram..."
  send_telegram "$MSG"
  echo "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ."

else
  # –ù–∞–≥—Ä—É–∑–∫–∞ –≤ –Ω–æ—Ä–º–µ
  echo "–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã."
fi

exit 0
